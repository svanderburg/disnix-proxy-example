#!/bin/bash -e

export PATH=@PREFIX@/bin:$PATH

case "$1" in
    lock)
        if [ -f /tmp/disnix-tcp-proxy-@srcPort@.lock ]
        then
            exit 1
        else
            touch /tmp/disnix-tcp-proxy-@srcPort@.lock

            if [ "$(ps aux | grep disnix-tcp-proxy)" != "" ] # Only obtain a lock when the service is running
            then
                while [ "$(disnix-tcp-proxy-client)" != "0" ]
                do
                    sleep 1
                done
            fi
        fi
        ;;
    unlock)
        rm -f /tmp/disnix-tcp-proxy-@srcPort@.lock
        ;;
    *)
        @DYSNOMIA_MODULE@ "$1" "@PREFIX@"
        ;;
esac
