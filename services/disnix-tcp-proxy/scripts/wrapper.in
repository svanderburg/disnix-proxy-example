#!/bin/bash -e

export PATH=@PREFIX@/bin:$PATH

case "$1" in
    activate)
	nohup disnix-tcp-proxy @srcPort@ @destHostname@ @destPort@ /tmp/disnix-tcp-proxy-@srcPort@.lock > /var/log/$(basename @PREFIX@).log & pid=$!
	echo $pid > /var/run/$(basename @PREFIX@).pid
        ;;
    deactivate)
        kill $(cat /var/run/@PREFIX@.pid)
	rm -f /var/run/$(basename @PREFIX@).pid
        ;;
    lock)
    	if [ -f /tmp/disnix-tcp-proxy-@srcPort@.lock ]
	then
	    exit 1
	else
	    touch /tmp/disnix-tcp-proxy-@srcPort@.lock
	    
	    if [ -f /var/run/$(basename @PREFIX@).pid ]
	    then
		while [ "$(disnix-tcp-proxy-client)" != "0" ]
		do
	    	    sleep 1
		done
	    fi
	fi
        ;;
    unlock)
        rm -f /tmp/disnix-tcp-proxy-@srcPort@.lock
        ;;
esac
